----1----Create a query that calculates the average number of goals per game between 1900 and 2000.
SELECT 
    AVG(home_score + away_score) AS avg_goals_per_game
FROM results
WHERE YEAR(date) BETWEEN 1900 AND 2000;

----2----Create a query that counts the number of shootouts wins by country and arrange in alphabetical order.
SELECT winner AS country, COUNT(*) AS shootout_wins
FROM shootouts
GROUP BY winner
ORDER BY country ASC;

----3----Create a reliable key that allows the joining together of goal scorers, results, and shootouts.
ALTER TABLE results
ADD CONSTRAINT pk_results
PRIMARY KEY (date, home_team, away_team);

ALTER TABLE goalscorers
ADD CONSTRAINT fk_goalscorers_results
FOREIGN KEY (date, home_team, away_team)
REFERENCES results(date, home_team, away_team);

ALTER TABLE shootouts
ADD CONSTRAINT fk_shootouts_results
FOREIGN KEY (date, home_team, away_team)
REFERENCES results(date, home_team, away_team);

----4-----Create a query that identifies which teams have won a penalty shootout after a 1-1 draw.
SELECT 
    r.home_team,
    r.away_team,
    s.winner AS shootout_winner
FROM results r
INNER JOIN shootouts s
    ON r.date = s.date
    AND r.home_team = s.home_team
    AND r.away_team = s.away_team
WHERE r.home_score = 1
  AND r.away_score = 1;

----5----Create a query that identifies the top goal scorer by tournament, and what percentage that equates to for all goals scored in the tournament.
-- 1. Total goals per tournament
WITH tournament_totals AS (
    SELECT 
        r.tournament,
        COUNT(*) AS total_goals
    FROM goalscorers g
    INNER JOIN results r
        ON g.date = r.date
        AND g.home_team = r.home_team
        AND g.away_team = r.away_team
    GROUP BY r.tournament
),

-- 2. Goals per scorer per tournament
scorer_totals AS (
    SELECT 
        r.tournament,
        g.scorer,
        COUNT(*) AS goals_scored
    FROM goalscorers g
    INNER JOIN results r
        ON g.date = r.date
        AND g.home_team = r.home_team
        AND g.away_team = r.away_team
    GROUP BY r.tournament, g.scorer
)

-- 3. Join and pick top scorer per tournament
SELECT 
    s.tournament,
    s.scorer,
    s.goals_scored,
    t.total_goals,
    (s.goals_scored / t.total_goals * 100) AS pct_of_tournament
FROM scorer_totals s
INNER JOIN tournament_totals t
    ON s.tournament = t.tournament
WHERE s.goals_scored = (
    SELECT MAX(goals_scored) 
    FROM scorer_totals 
    WHERE tournament = s.tournament
);

----6----Create and additional column that flags records with data quality issues
SELECT home_score,
    CASE
        WHEN home_score < 0 OR away_score < 0 THEN 'Invalid negative score'
        ELSE 'OK'
    END AS data_quality_flag
FROM results;

SELECT minute,
    CASE
        WHEN minute < 0 OR minute > 120 THEN 'Unrealistic minute'
        ELSE 'OK'
    END AS data_quality_flag
FROM goalscorers;

SELECT first_shooter,
    CASE
        WHEN first_shooter = '' THEN 'change to NULL'
        ELSE 'OK'
    END AS data_quality_flag
FROM shootouts;

----7----Resolve the identified quality issues
----negScores----
UPDATE results
SET home_score = 0
WHERE home_score < 0;

UPDATE results
SET away_score = 0
WHERE away_score < 0;

----Fix goal scorerEntries----
UPDATE goalscorers
SET minute = NULL
WHERE minute < 0 OR minute > 120;

----ChangeToNull----
UPDATE shootouts
SET first_shooter = NULL
WHERE first_shooter = '';
